{% extends 'base.html' %} {% load static %} {# Заголовок страницы #} 
{% block title %}Карта добрых дел{% endblock %} {# Дополнительные стили #} 
{% block extra_css %}
<link href="{% static 'css/index.css' %}" rel="stylesheet" />
{% endblock %} {# Специальный класс для body - фиксированная высота для карты #}
{% block body_class %}overflow-hidden{% endblock %} 
{# Класс для main - убираем отступы #} {% block main_class %}{% endblock %} 
{# Используем стандартный header из partials/header.html #} {# Отключаем футер на главной странице #} 
{% block footer %} {% endblock %} {# Основной контент #} {% block content %} 
{# Модальное окно НКО #} {% include 'partials/nko_modal.html' %} 

{# Системные сообщения - плавающие поверх карты #}
{% if messages %}
<div class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-2xl px-4" id="messages-container">
  {% for message in messages %}
  <div class="mb-3 rounded-lg shadow-xl p-4 {% if message.tags == 'error' %}bg-red-500 text-white{% elif message.tags == 'warning' %}bg-yellow-500 text-white{% elif message.tags == 'success' %}bg-green-500 text-white{% else %}bg-blue-500 text-white{% endif %} animate-slide-down message-alert" role="alert">
    <div class="flex items-start justify-between">
      <div class="flex-1">
        <p class="font-bold text-sm mb-1">
          {% if message.tags == 'error' %}❌ Ошибка
          {% elif message.tags == 'warning' %}⚠️ Внимание
          {% elif message.tags == 'success' %}✅ Успешно
          {% else %}ℹ️ Информация
          {% endif %}
        </p>
        <p class="text-sm">{{ message }}</p>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200 font-bold text-xl leading-none">&times;</button>
    </div>
  </div>
  {% endfor %}
</div>
<script>
  // Автоматически скрывать сообщения через 8 секунд
  setTimeout(() => {
    const messages = document.querySelectorAll('.message-alert');
    messages.forEach(msg => {
      msg.style.transition = 'opacity 0.5s ease-out';
      msg.style.opacity = '0';
      setTimeout(() => msg.remove(), 500);
    });
  }, 8000);
</script>
{% endif %}

{# Главный контейнер с картой и фильтрами #}
<main class="main-container flex flex-col md:flex-row">
  {# Левая панель с фильтрами #} {% include 'partials/filter_panel.html' %} 
  {# Контейнер с картой (правая часть) #}
  <div
    id="map"
    class="map-container min-h-[400px] md:min-h-0 bg-gray-200 dark:bg-gray-900 relative"
  >
    {# Карта инициализируется через JavaScript #}
  </div>
</main>

{% endblock %} {# JavaScript #} {% block scripts %} 
{# Подключение Яндекс Карт API #}
<script
  src="https://api-maps.yandex.ru/2.1/?apikey={{ YANDEX_MAPS_API_KEY }}&lang=ru_RU"
  type="text/javascript"
></script>

{# Основной скрипт инициализации карты и UI #}
<script type="module">
  import { fetchAndInit } from '{% static "js/main.js" %}';

  // Ожидаем загрузки Яндекс Карт, затем инициализируем
  function tryInit() {
    if (typeof ymaps !== "undefined") {
      fetchAndInit();
    } else {
      setTimeout(tryInit, 200);
    }
  }
  tryInit();
</script>
{% endblock %} {# Скрипт переключения темы #} {% block theme_script %}
<script>
  // Инициализация темной темы
  const themeToggleBtn = document.getElementById("theme-toggle");
  const htmlElement = document.documentElement;

  if (
    localStorage.theme === "dark" ||
    (!("theme" in localStorage) &&
      window.matchMedia("(prefers-color-scheme: dark)").matches)
  ) {
    htmlElement.classList.add("dark");
  } else {
    htmlElement.classList.remove("dark");
  }

  if (themeToggleBtn) {
    themeToggleBtn.addEventListener("click", () => {
      if (htmlElement.classList.contains("dark")) {
        htmlElement.classList.remove("dark");
        localStorage.theme = "light";
      } else {
        htmlElement.classList.add("dark");
        localStorage.theme = "dark";
      }
    });
  }
</script>
{% endblock %}
